{% extends "base.html" %}

{% block title %}Relatório de Guerra do Clã{% endblock %}

{% block content %}
<header>
    <h1>{{ report_title }}</h1>
    <p>Dados oficiais da Supercell, atualizados em: {{ report_date }}</p>
    <div class="metrics-info">
        <strong>Definição do Player Status</strong><br>
        - <strong>Campeão:</strong> Usou 16 nas 2 últimas guerras;<br>
        - <strong>Ok:</strong> Uso de 12 a 15 decks. Abaixo dos Campeões;<br>
        - <strong>Verificar:</strong> Criticidade. Utilizou de 11 a menos decks em alguma das duas últimas guerras, ou é um jogador sem histórico;<br>
        - O símbolo <strong>'-'</strong> indica que o jogador não estava no clã naquela guerra específica.
    </div>
</header>

<div class="content-container">
    {% if data_found %}
    <div class="table-container">
        <table id="war-report-table" class="display">
            <thead>
                <tr>
                    {% for key, value in column_headers.items() %}
                        <th>{{ value }}</th>
                    {% endfor %}
                </tr>
            </thead>
            <tbody>
                {% for player in players %}
                <tr>
                    {% for key in column_headers.keys() %}
                        {# Define a classe do heatmap com base nos decks usados #}
                        {% set war_data = player[key] %}
                        {% set decks_used = war_data.get('decks_used', -1) if war_data is mapping else -1 %}
                        {% set heatmap_class = 'heatmap-high' if decks_used == 16 else
                                             'heatmap-medium' if decks_used >= 12 else
                                             'heatmap-low' if decks_used >= 8 else
                                             'heatmap-critical' if decks_used >= 0 else '' %}

                        <td class="{{ heatmap_class if key.startswith('Guerra') or key == 'Última Guerra' else '' }}">
                            {% if key == 'Player Status' %}
                                <span class="status status-{{ player[key] | lower }}">
                                    {{ player[key] }}
                                </span>
                            {% elif player[key] is mapping %}
                                {# Verifica se o valor é um dicionário (mapeamento) #}
                                {% if player[key] %}
                                    <div class="war-data">
                                        <span class="decks-used">{{ player[key].get('decks_used', '-') }}</span> /
                                        <span class="fame">{{ player[key].get('fame', '-') }}</span>
                                        <span class="decks-remaining">({{ player[key].get('decks_remaining', '-') }})</span>
                                    </div>
                                {% else %}
                                    -
                                {% endif %}
                            {% else %}
                                {{ player[key] }}
                            {% endif %}
                        </td>
                    {% endfor %}
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <div class="diagnostic-container">
        <h2>Diagnóstico da Última Atualização</h2>
        <p>Nenhum dado de jogador foi encontrado. Veja abaixo o log do processo de atualização para entender o motivo:</p>
        <div class="log-box">
            <ul>
                {% for msg in log_messages %}
                <li>{{ msg }}</li>
                {% else %}
                <li>Nenhum log de diagnóstico foi encontrado. Execute o processo de atualização.</li>
                {% endfor %}
            </ul>
        </div>
        <p><strong>Possíveis causas:</strong></p>
        <ul>
            <li>A <strong>Clan Tag</strong> configurada na sua variável de ambiente do Windows pode estar incorreta.</li>
            <li>O clã pode não estar em uma guerra no momento e não há histórico de guerras com participantes.</li>
            <li>A API da Supercell pode estar temporariamente indisponível. Verifique o status em <a href="https://developer.clashroyale.com/" target="_blank">developer.clashroyale.com</a>.</li>
        </ul>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
{% if data_found %}
<script>
$(document).ready(function() {
    $('#war-report-table').DataTable({
        "responsive": true,
        "pageLength": 25,
        "lengthMenu": [ [10, 25, 50, -1], [10, 25, 50, "Todos"] ],
        "language": {
            "url": "https://cdn.datatables.net/plug-ins/1.10.25/i18n/Portuguese-Brasil.json"
        },
        dom: 'Bfrtip',
        buttons: [
            {
                extend: 'excelHtml5',
                text: 'Exportar para Excel',
                title: 'Relatorio de Guerra - {{ report_date }}'
            },
            {
                extend: 'pdfHtml5',
                text: 'Exportar para PDF',
                title: 'Relatorio de Guerra - {{ report_date }}',
                orientation: 'landscape',
                pageSize: 'A4'
            }
        ]
    });
});
</script>
{% endif %}
{% endblock %}
